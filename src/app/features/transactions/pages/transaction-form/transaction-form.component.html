<div>
  <app-details-page-header [hasDelete]="false" [hasEdit]="false" (back)="onCancel()">
  </app-details-page-header>
  <h1>{{ isEditMode ? 'Edit Transaction' : 'Create New Transaction' }}</h1>

  <form [formGroup]="transactionForm" (ngSubmit)="onSubmit()" class="transaction-form">
    <div class="form-section">
      <h2>Transaction Details</h2>
      <div class="form-grid">
        <div class="form-group">
          <app-dropdown
            formControlName="transactionType"
            label="Transaction Type"
            [options]="transactionTypeOptions"
            optionLabel="label"
            optionValue="value"
            placeholder="Select transaction type"
            [required]="true"
            [filter]="false"
            (onChange)="onChangeTransactionType($event)"
          ></app-dropdown>
          <p class="help-text">
            @if (transactionForm.get('transactionType')?.value === 'purchases') {
            <span>Purchases: Stock coming in from suppliers</span>
            } @else if (transactionForm.get('transactionType')?.value === 'sales') {
            <span>Sales: Stock going out to customers</span>
            }
          </p>
        </div>

        <div class="form-group">
          <app-dropdown
            formControlName="partnerId"
            label="Partner"
            [options]="partners"
            optionLabel="name"
            optionValue="_id"
            [placeholder]="partnersPlaceholder"
            [required]="transactionForm.get('transactionType')?.value === 'sales'"
            [filter]="true"
            [loading]="loadingPartners"
            [disabled]="!transactionForm.get('transactionType')?.value"
            (onScrollEnd)="onPartnerScrollEnd()"
            (onSearch)="onPartnerSearch($event)"
          ></app-dropdown>
          <p class="help-text">
            {{ partnersHelpText }}
          </p>
        </div>
      </div>
    </div>

    @if (transactionType==TransactionType.PURCHASES|| transactionType==TransactionType.SALES) {
    <div class="form-section">
      <div class="section-header">
        <h2>Products</h2>
        <button type="button" class="btn btn-secondary btn-sm" (click)="addProduct(true)">
          <lucide-icon [img]="Plus" [size]="16"></lucide-icon>
          <span>Add Product</span>
        </button>
      </div>

      <div formArrayName="products" class="products-list">
        @for (product of productsArray.controls; track product; let i = $index) {
        <div [formGroupName]="i" class="product-row" #productRow>
          <div class="product-row-number">{{ i + 1 }}</div>
          <div class="product-row-content">
            <div class="form-group">
              <app-dropdown
                #productDropdown
                formControlName="productId"
                label="Product"
                [options]="products"
                optionLabel="name"
                optionValue="_id"
                placeholder="Select product"
                [required]="true"
                [filter]="true"
                [loading]="loadingProducts"
                (onScrollEnd)="onProductScrollEnd()"
                (onSearch)="onProductSearch($event)"
                (onChange)="onProductChange($event, i)"
              ></app-dropdown>
            </div>

            <div class="form-group">
              <app-form-input
                formControlName="currentQuantity"
                label="Current Stock"
                type="number"
                placeholder="Select product first"
                [disabled]="true"
              ></app-form-input>
            </div>
            <div class="form-group">
              <app-form-input
                formControlName="sellingPrice"
                label="Selling price"
                type="number"
                placeholder="Select product first"
                [disabled]="transactionType == TransactionType.SALES"
                [hidden]="transactionType !== TransactionType.SALES"
              ></app-form-input>

              <app-form-input
                #costPriceInput
                formControlName="costPrice"
                label="Cost price"
                type="number"
                placeholder="Select product first"
                [disabled]="transactionType !== TransactionType.PURCHASES"
                [hidden]="transactionType !== TransactionType.PURCHASES"
                [required]="transactionType === TransactionType.PURCHASES"
                (change)="onChangeCostPrice($event, i)"
                (keydown)="onCostPriceKeydown($event, i)"
              ></app-form-input>
            </div>

            <div class="form-group">
              <app-form-input
                formControlName="totalProductPrice"
                label="Total price"
                type="number"
                placeholder="Select product first"
                [disabled]="true"
              ></app-form-input>
            </div>

            <div class="form-group">
              <app-form-input
                #quantityInput
                formControlName="quantity"
                label="Transaction Qty"
                type="number"
                placeholder="Enter quantity"
                [required]="true"
                (keydown)="onQuantityKeydown($event, i)"
                (change)="onChangeQuantity($event, i)"
              ></app-form-input>
            </div>

            <button
              type="button"
              class="btn btn-danger btn-icon"
              (click)="removeProduct(i)"
              [disabled]="productsArray.length === 1"
              title="Remove product"
            >
              <lucide-icon [img]="Trash2" [size]="18"></lucide-icon>
            </button>
          </div>
        </div>
        } @empty {
        <div class="empty-products">
          <p>No products added yet. Click "Add Product" to start.</p>
        </div>
        }
      </div>
    </div>
    }

    <div class="form-section">
      <h2>Additional Information</h2>
      <div class="info-grid">
        <div class="form-group">
          <app-form-input
            formControlName="balance"
            label="Balance"
            type="number"
            placeholder="Enter balance"
            [required]="true"
            (change)="onChangeBalance($event)"
          ></app-form-input>
        </div>
        <div class="form-group">
          <app-form-input
            #paidInput
            formControlName="paid"
            label="Paid"
            type="number"
            placeholder="Enter paid amount"
            [required]="true"
            (change)="onPaidChange($event)"
          ></app-form-input>
        </div>
        <div class="form-group">
          <app-form-input
            formControlName="left"
            label="Left"
            type="number"
            [disabled]="true"
          ></app-form-input>
        </div>
      </div>
      <div class="form-group full-width">
        <app-form-input
          formControlName="note"
          label="Note"
          type="textarea"
          placeholder="Enter transaction note (optional)"
          [rows]="3"
          (keydown)="submitOnPressEnter($event)"
        ></app-form-input>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="onCancel()">Cancel</button>
      <button type="submit" class="btn btn-primary">
        @if (loading$ | async) {
        <span>Saving...</span>
        } @else {
        <span>{{ isEditMode ? 'Update' : 'Create' }} Transaction</span>
        }
      </button>
    </div>
  </form>
</div>
