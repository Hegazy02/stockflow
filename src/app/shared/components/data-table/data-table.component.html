<div class="table-container" [class.scrollable]="scrollable" [style.max-height]="height">
  <p-table
    #dt
    [value]="data"
    [columns]="columns"
    [paginator]="false"
    [loading]="loading"
    [globalFilterFields]="globalFilterFields"
    [dataKey]="dataKey"
    [selectionMode]="selectionMode"
    [(selection)]="selectedRows"
    (onRowSelect)="onRowSelect($event)"
    (onRowUnselect)="onRowUnselect($event)"
    (onHeaderCheckboxToggle)="onHeaderCheckboxToggle($event)"
    styleClass="p-datatable-sm"
    [tableStyle]="{ 'min-width': '50rem' }"
    [scrollHeight]="height"
  >
    <!-- Table Header -->
    <ng-template pTemplate="header">
      <tr>
        <!-- Selection Column -->
        @if (selectionMode === 'multiple') {
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        }

        <!-- Data Columns -->
        @for (col of columns; track col.field; let i = $index) {
        <th [style.width]="col.width">
          <div class="header-content">
            <span>{{ col.header }}</span>
            @if (showFilters && col.filterable) {
            <div class="header-icons">
              <button
                type="button"
                class="filter-icon-btn"
                [class.active]="hasActiveFilter(col.field)"
                (click)="toggleFilterPopover($event, col.field)"
                [title]="'Filter ' + col.header"
              >
                <lucide-icon [img]="Filter" [size]="14"></lucide-icon>
              </button>
              <p-popover [attr.data-field]="col.field">
                <div class="filter-popup">
                  <div class="filter-header">
                    <span>Filter {{ col.header }}</span>
                    <button type="button" class="close-btn" (click)="hideFilterPopover(col.field)">
                      <lucide-icon [img]="X" [size]="16"></lucide-icon>
                    </button>
                  </div>
                  <div class="filter-body">
                    @if (!col.filterTypes || col.filterTypes.includes("text")) {
                    <input
                      pInputText
                      type="text"
                      [placeholder]="'Search ' + col.header"
                      [(ngModel)]="filterValues[col.field]"
                      (input)="applyFilter(dt, col.field, filterValues[col.field])"
                      class="filter-input-popup"
                    />
                    } @if (col.filterTypes?.includes("dropdown") && col.dropdownConfig) {
                    <app-dropdown
                      [label]="col.header"
                      [hasLabel]="false"
                      [options]="col.dropdownConfig.options"
                      [optionLabel]="col.dropdownConfig.optionLabel"
                      [optionValue]="col.dropdownConfig.optionValue"
                      [selectedValue]="col.dropdownConfig.selectedValue"
                      [placeholder]="'Select ' + col.header"
                      (onChange)="applyFilter(dt, col.field, $event)"
                    ></app-dropdown>
                    }
                  </div>
                  <div class="filter-footer">
                    <button type="button" class="btn-clear" (click)="clearFilter(dt, col.field)">
                      Clear
                    </button>
                  </div>
                </div>
              </p-popover>
            </div>
            }
          </div>
        </th>
        }

        <!-- Actions Column -->
        @if (showActions && actions.length > 0) {
        <th style="width: 150px">Actions</th>
        }
      </tr>
    </ng-template>

    <!-- Table Body -->
    <ng-template pTemplate="body" let-rowData>
      <tr>
        <!-- Selection Column -->
        @if (selectionMode === 'multiple') {
        <td>
          <p-tableCheckbox [value]="rowData"></p-tableCheckbox>
        </td>
        }

        <!-- Data Columns -->
        @for (col of columns; track col.field) {
        <td>
          {{ formatCellValue(rowData, col) }}
        </td>
        }

        <!-- Actions Column -->
        @if (showActions && actions.length > 0) {
        <td>
          <div class="action-buttons">
            @for (action of actions; track action.label) {
            <button
              class="action-btn"
              [class]="action.styleClass"
              (click)="executeAction(action, rowData)"
              [title]="action.label"
            >
              <lucide-icon [img]="action.icon" [size]="16"></lucide-icon>
            </button>
            }
          </div>
        </td>
        }
      </tr>
    </ng-template>

    <!-- Empty Message -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td
          [attr.colspan]="
            columns.length + (showActions ? 1 : 0) + (selectionMode === 'multiple' ? 1 : 0)
          "
        >
          <div class="empty-message">
            <p>No records found</p>
          </div>
        </td>
      </tr>
    </ng-template>

    <!-- Loading -->
    <ng-template pTemplate="loadingbody">
      <tr>
        <td
          [attr.colspan]="
            columns.length + (showActions ? 1 : 0) + (selectionMode === 'multiple' ? 1 : 0)
          "
        >
          <div class="loading-message">
            <p>Loading data...</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  @if (paginator && totalRecords > 0) {
  <div class="pagination-container" [class.disabled]="loading">
    <div class="pagination-info">Showing {{ first + 1 }}-{{ last }} of {{ totalRecords }}</div>

    <p-paginator
      [appendTo]="'body'"
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [rowsPerPageOptions]="rowsPerPageOptions"
      [first]="first"
      [showJumpToPageDropdown]="false"
      [showPageLinks]="true"
      (onPageChange)="onPageChange($event)"
    ></p-paginator>
  </div>
  }
</div>
